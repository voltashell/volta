<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Flock Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: #1e1e1e;
            color: #ffffff;
            overflow: hidden;
        }

        .header {
            background: #2d2d2d;
            padding: 10px 20px;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            font-size: 18px;
            font-weight: bold;
            color: #00ff00;
        }

        .stats {
            display: flex;
            gap: 20px;
            font-size: 12px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label {
            color: #888;
            margin-bottom: 2px;
        }

        .stat-value {
            color: #00ff00;
            font-weight: bold;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 60px);
        }

        .container-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            height: calc(100vh - 260px);
            gap: 1px;
            background: #404040;
        }

        .terminal-panel {
            background: #1a1a1a;
            border-top: 1px solid #404040;
            height: 200px;
            display: flex;
            flex-direction: column;
        }

        .terminal-header {
            background: #2d2d2d;
            padding: 8px 12px;
            border-bottom: 1px solid #404040;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .terminal-title {
            font-weight: bold;
            font-size: 12px;
            color: #00ff00;
        }

        .terminal-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .terminal-target {
            background: #404040;
            color: #ffffff;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-family: inherit;
        }

        .terminal-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .terminal-output {
            flex: 1;
            padding: 8px;
            overflow-y: auto;
            overflow-x: hidden;
            font-size: 11px;
            line-height: 1.4;
            background: #1a1a1a;
            min-height: 0;
        }

        .terminal-input-area {
            border-top: 1px solid #404040;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .terminal-prompt {
            color: #00ff00;
            font-weight: bold;
            font-size: 12px;
            min-width: 20px;
        }

        .terminal-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #ffffff;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            outline: none;
            padding: 4px;
        }

        .terminal-send {
            background: #00ff00;
            color: #000000;
            border: none;
            padding: 4px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
        }

        .terminal-send:hover {
            background: #00dd00;
        }

        .terminal-send:disabled {
            background: #666;
            color: #aaa;
            cursor: not-allowed;
        }

        .command-entry {
            margin-bottom: 8px;
        }

        .command-input {
            color: #00ff00;
            margin-bottom: 2px;
        }

        .command-output {
            color: #ffffff;
            margin-left: 16px;
            white-space: pre-wrap;
        }

        .command-error {
            color: #e74c3c;
            margin-left: 16px;
            white-space: pre-wrap;
        }

        .command-timestamp {
            color: #666;
            font-size: 10px;
        }

        .container-window {
            background: #1e1e1e;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .container-header {
            background: #2d2d2d;
            padding: 8px 12px;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .container-name {
            font-weight: bold;
            font-size: 14px;
        }

        .agent-1 .container-name { color: #ff6b6b; }
        .agent-2 .container-name { color: #4ecdc4; }
        .agent-3 .container-name { color: #45b7d1; }
        .nats .container-name { color: #f9ca24; }

        .container-controls {
            display: flex;
            gap: 8px;
        }

        .btn {
            background: #404040;
            color: #ffffff;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            font-family: inherit;
        }

        .btn:hover {
            background: #555;
        }

        .btn.restart {
            background: #e74c3c;
        }

        .btn.restart:hover {
            background: #c0392b;
        }

        .container-status {
            padding: 0 12px;
            font-size: 11px;
            color: #888;
            border-bottom: 1px solid #404040;
            line-height: 24px;
        }

        .status-running { color: #2ecc71; }
        .status-stopped { color: #e74c3c; }

        .log-window {
            flex: 1;
            padding: 8px;
            overflow-y: auto;
            overflow-x: hidden;
            font-size: 11px;
            line-height: 1.4;
            background: #1a1a1a;
            min-height: 0;
        }

        .log-entry {
            margin-bottom: 2px;
            word-wrap: break-word;
        }

        .log-timestamp {
            color: #666;
            margin-right: 8px;
        }

        .log-error {
            color: #e74c3c;
        }

        .log-info {
            color: #ffffff;
        }

        .log-success {
            color: #2ecc71;
        }

        .log-warning {
            color: #f39c12;
        }

        /* Scrollbar styling */
        .log-window::-webkit-scrollbar {
            width: 6px;
        }

        .log-window::-webkit-scrollbar-track {
            background: #2d2d2d;
        }

        .log-window::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 3px;
        }

        .log-window::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 20px;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            z-index: 1000;
        }

        .connected {
            background: #2ecc71;
            color: white;
        }

        .disconnected {
            background: #e74c3c;
            color: white;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">Connecting...</div>
    
    <div class="header">
        <div class="title">🤖 AI Flock Monitor</div>
        <div class="stats" id="stats">
            <div class="stat-item">
                <div class="stat-label">Containers</div>
                <div class="stat-value" id="containerCount">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">CPU</div>
                <div class="stat-value" id="totalCpu">0%</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Memory</div>
                <div class="stat-value" id="totalMem">0MB</div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="container-grid">
            <div class="container-window agent-1" id="agent-1-window">
                <div class="container-header">
                    <div class="container-name">Agent 1</div>
                    <div class="container-controls">
                        <button class="btn restart" onclick="restartContainer('agent-1')">Restart</button>
                        <button class="btn" onclick="clearLogs('agent-1')">Clear</button>
                    </div>
                </div>
                <div class="container-status" id="agent-1-status">Status: Unknown</div>
                <div class="log-window" id="agent-1-logs"></div>
            </div>

            <div class="container-window agent-2" id="agent-2-window">
                <div class="container-header">
                    <div class="container-name">Agent 2</div>
                    <div class="container-controls">
                        <button class="btn restart" onclick="restartContainer('agent-2')">Restart</button>
                        <button class="btn" onclick="clearLogs('agent-2')">Clear</button>
                    </div>
                </div>
                <div class="container-status" id="agent-2-status">Status: Unknown</div>
                <div class="log-window" id="agent-2-logs"></div>
            </div>

            <div class="container-window agent-3" id="agent-3-window">
                <div class="container-header">
                    <div class="container-name">Agent 3</div>
                    <div class="container-controls">
                        <button class="btn restart" onclick="restartContainer('agent-3')">Restart</button>
                        <button class="btn" onclick="clearLogs('agent-3')">Clear</button>
                    </div>
                </div>
                <div class="container-status" id="agent-3-status">Status: Unknown</div>
                <div class="log-window" id="agent-3-logs"></div>
            </div>

            <div class="container-window nats" id="nats-window">
                <div class="container-header">
                    <div class="container-name">NATS Server</div>
                    <div class="container-controls">
                        <button class="btn restart" onclick="restartContainer('nats')">Restart</button>
                        <button class="btn" onclick="clearLogs('nats')">Clear</button>
                    </div>
                </div>
                <div class="container-status" id="nats-status">Status: Unknown</div>
                <div class="log-window" id="nats-logs"></div>
            </div>
        </div>

        <div class="terminal-panel">
            <div class="terminal-header">
                <div class="terminal-title">🖥️ Terminal</div>
                <div class="terminal-controls">
                    <label for="terminal-target" style="color: #888; font-size: 11px;">Target:</label>
                    <select id="terminal-target" class="terminal-target">
                        <option value="host">Host</option>
                        <option value="all">All Agents</option>
                        <option value="agent-1">Agent 1</option>
                        <option value="agent-2">Agent 2</option>
                        <option value="agent-3">Agent 3</option>
                        <option value="nats">NATS</option>
                    </select>
                    <button class="btn" onclick="clearTerminal()">Clear</button>
                    <button class="btn" onclick="openShell()">Shell</button>
                </div>
            </div>
            <div class="terminal-content">
                <div class="terminal-output" id="terminal-output"></div>
                <div class="terminal-input-area">
                    <div class="terminal-prompt">$</div>
                    <input type="text" class="terminal-input" id="terminal-input" placeholder="Enter command..." autocomplete="off">
                    <button class="terminal-send" id="terminal-send" onclick="sendCommand()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const connectionStatus = document.getElementById('connectionStatus');
        
        let isConnected = false;
        let logCounts = {
            'agent-1': 0,
            'agent-2': 0,
            'agent-3': 0,
            'nats': 0
        };
        
        let commandHistory = [];
        let historyIndex = -1;

        // Connection status
        socket.on('connect', () => {
            isConnected = true;
            connectionStatus.textContent = 'Connected';
            connectionStatus.className = 'connection-status connected';
        });

        socket.on('disconnect', () => {
            isConnected = false;
            connectionStatus.textContent = 'Disconnected';
            connectionStatus.className = 'connection-status disconnected';
        });

        // Handle log messages
        socket.on('log', (logData) => {
            const { container, data, timestamp, isError } = logData;
            const logWindow = document.getElementById(`${container}-logs`);
            
            if (logWindow) {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                
                const timeStr = new Date(timestamp).toLocaleTimeString();
                const logClass = isError ? 'log-error' : getLogClass(data);
                
                logEntry.innerHTML = `<span class="log-timestamp">${timeStr}</span><span class="${logClass}">${escapeHtml(data.trim())}</span>`;
                
                logWindow.appendChild(logEntry);
                logCounts[container]++;
                
                // Auto-scroll to bottom
                logWindow.scrollTop = logWindow.scrollHeight;
                
                // Limit log entries to prevent memory issues
                if (logCounts[container] > 1000) {
                    logWindow.removeChild(logWindow.firstChild);
                    logCounts[container]--;
                }
            }
        });

        // Handle stats updates
        socket.on('stats', (stats) => {
            updateStats(stats);
        });

        // Handle container restart responses
        socket.on('container-restarted', (data) => {
            const { container, success } = data;
            const statusElement = document.getElementById(`${container}-status`);
            if (statusElement) {
                statusElement.textContent = success ? 'Status: Restarted' : 'Status: Restart Failed';
                statusElement.className = success ? 'container-status status-running' : 'container-status status-stopped';
            }
        });

        // Handle errors
        socket.on('error', (errorData) => {
            const { container, message } = errorData;
            const logWindow = document.getElementById(`${container}-logs`);
            if (logWindow) {
                const errorEntry = document.createElement('div');
                errorEntry.className = 'log-entry';
                errorEntry.innerHTML = `<span class="log-timestamp">${new Date().toLocaleTimeString()}</span><span class="log-error">ERROR: ${escapeHtml(message)}</span>`;
                logWindow.appendChild(errorEntry);
                logWindow.scrollTop = logWindow.scrollHeight;
            }
        });

        // Handle command results
        socket.on('command-result', (result) => {
            displayCommandResult(result);
        });

        // Utility functions
        function getLogClass(logText) {
            const text = logText.toLowerCase();
            if (text.includes('error') || text.includes('failed')) return 'log-error';
            if (text.includes('warn')) return 'log-warning';
            if (text.includes('connected') || text.includes('started') || text.includes('ready')) return 'log-success';
            return 'log-info';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function restartContainer(containerName) {
            if (confirm(`Restart ${containerName}?`)) {
                socket.emit('restart-container', containerName);
            }
        }

        function clearLogs(containerName) {
            const logWindow = document.getElementById(`${containerName}-logs`);
            if (logWindow) {
                logWindow.innerHTML = '';
                logCounts[containerName] = 0;
            }
        }

        function updateStats(stats) {
            const containerCount = document.getElementById('containerCount');
            const totalCpu = document.getElementById('totalCpu');
            const totalMem = document.getElementById('totalMem');
            
            if (stats && stats.length > 0) {
                containerCount.textContent = stats.length;
                
                let cpuSum = 0;
                let memSum = 0;
                
                stats.forEach(stat => {
                    // Update individual container status
                    const statusElement = document.getElementById(`${stat.Name}-status`);
                    if (statusElement) {
                        const cpuPercent = parseFloat(stat.CPUPerc?.replace('%', '') || '0');
                        const memUsage = stat.MemUsage || '0B / 0B';
                        statusElement.innerHTML = `Status: <span class="status-running">Running</span> | CPU: ${stat.CPUPerc || '0%'} | Memory: ${memUsage}`;
                        statusElement.className = 'container-status status-running';
                        
                        cpuSum += cpuPercent;
                        memSum += parseFloat(stat.MemUsage?.split(' / ')[0]?.replace(/[^\d.]/g, '') || '0');
                    }
                });
                
                totalCpu.textContent = `${cpuSum.toFixed(1)}%`;
                totalMem.textContent = `${memSum.toFixed(0)}MB`;
            }
        }

        // Auto-reconnect on disconnect
        socket.on('disconnect', () => {
            setTimeout(() => {
                if (!isConnected) {
                    socket.connect();
                }
            }, 5000);
        });

        // Terminal functions
        function sendCommand() {
            const input = document.getElementById('terminal-input');
            const target = document.getElementById('terminal-target').value;
            const command = input.value.trim();
            
            if (!command) return;
            
            // Add to history
            commandHistory.unshift(command);
            if (commandHistory.length > 50) {
                commandHistory.pop();
            }
            historyIndex = -1;
            
            // Display command in terminal
            displayCommand(command, target);
            
            // Send command to server
            socket.emit('execute-command', {
                command: command,
                target: target,
                timestamp: new Date().toISOString()
            });
            
            // Clear input
            input.value = '';
            
            // Disable send button temporarily
            const sendButton = document.getElementById('terminal-send');
            sendButton.disabled = true;
            setTimeout(() => {
                sendButton.disabled = false;
            }, 500);
        }

        function displayCommand(command, target) {
            const output = document.getElementById('terminal-output');
            const entry = document.createElement('div');
            entry.className = 'command-entry';
            
            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `
                <div class="command-input">
                    <span class="command-timestamp">[${timestamp}]</span> 
                    <strong>${escapeHtml(target)}$</strong> ${escapeHtml(command)}
                </div>
            `;
            
            output.appendChild(entry);
            output.scrollTop = output.scrollHeight;
        }

        function displayCommandResult(result) {
            const output = document.getElementById('terminal-output');
            const entries = output.getElementsByClassName('command-entry');
            const lastEntry = entries[entries.length - 1];
            
            if (lastEntry) {
                const resultDiv = document.createElement('div');
                
                if (result.output && result.output !== 'No output') {
                    const outputDiv = document.createElement('div');
                    outputDiv.className = 'command-output';
                    outputDiv.textContent = result.output;
                    resultDiv.appendChild(outputDiv);
                }
                
                if (result.error) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'command-error';
                    errorDiv.textContent = result.error;
                    resultDiv.appendChild(errorDiv);
                }
                
                if (!result.output || result.output === 'No output') {
                    if (!result.error) {
                        const emptyDiv = document.createElement('div');
                        emptyDiv.className = 'command-output';
                        emptyDiv.textContent = '(no output)';
                        resultDiv.appendChild(emptyDiv);
                    }
                }
                
                lastEntry.appendChild(resultDiv);
            }
            
            output.scrollTop = output.scrollHeight;
        }

        function clearTerminal() {
            const output = document.getElementById('terminal-output');
            output.innerHTML = '';
        }

        function openShell() {
            const target = document.getElementById('terminal-target').value;
            
            if (target === 'all') {
                alert('Shell access not available for "All Agents". Please select a specific agent.');
                return;
            }
            
            if (target === 'host') {
                alert('Host shell access not implemented in web interface. Use terminal commands instead.');
                return;
            }
            
            // Display shell information
            const output = document.getElementById('terminal-output');
            const entry = document.createElement('div');
            entry.className = 'command-entry';
            
            const timestamp = new Date().toLocaleTimeString();
            const shellType = target.startsWith('agent-') ? 'bash' : 'sh';
            
            entry.innerHTML = `
                <div class="command-input">
                    <span class="command-timestamp">[${timestamp}]</span> 
                    <strong>Shell Access for ${target}</strong>
                </div>
                <div class="command-output">
                    To access ${target} shell directly, use one of these methods:
                    
                    1. Terminal command: npm run flock:shell:${target.replace('-', '')}
                    2. Docker command: docker exec -it ${target} /${shellType}
                    3. Use the terminal above to send individual commands
                    
                    The container is running with ${shellType} shell support.
                </div>
            `;
            
            output.appendChild(entry);
            output.scrollTop = output.scrollHeight;
        }

        // Terminal input event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const terminalInput = document.getElementById('terminal-input');
            
            // Enter key to send command
            terminalInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    sendCommand();
                    e.preventDefault();
                } else if (e.key === 'ArrowUp') {
                    // Navigate command history up
                    if (historyIndex < commandHistory.length - 1) {
                        historyIndex++;
                        terminalInput.value = commandHistory[historyIndex];
                    }
                    e.preventDefault();
                } else if (e.key === 'ArrowDown') {
                    // Navigate command history down
                    if (historyIndex > 0) {
                        historyIndex--;
                        terminalInput.value = commandHistory[historyIndex];
                    } else if (historyIndex === 0) {
                        historyIndex = -1;
                        terminalInput.value = '';
                    }
                    e.preventDefault();
                }
            });
            
            // Focus terminal input when typing anywhere
            document.addEventListener('keypress', (e) => {
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
                    terminalInput.focus();
                }
            });
        });
    </script>
</body>
</html>